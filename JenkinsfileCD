node {
  stage('SCM') {
    checkout scm
  }
  stage('Install and Build') { 
    nodejs(nodeJSInstallationName: 'NodeJS') {
      sh 'npm install'
      sh 'ng build --configuration=production'
    }
  }
  stage('Deploy') {
    sshagent(credentials: ['nginx']) {
      sh '''
        date_backup=backup-$(date +%d)-$(date +%m)-$(date +%Y)-$(date +%H):$(date +%M):$(date +%S)
        pathDeploy=./DeployWeb
        pathDeployWeb=$pathDeploy/www
        pathDeployBackup=$pathDeploy/backup
        remoteUser=remote_jenkins
        remoteHost=nginx
        ssh $remoteUser@$remoteHost mkdir $pathDeployBackup/$date_backup
        ssh $remoteUser@$remoteHost mv $pathDeployWeb/* $pathDeployBackup/$date_backup
        scp -r ./dist/DeyApps/* $remoteUser@$remoteHost:$pathDeployWeb
      '''
    }   
  }
}
